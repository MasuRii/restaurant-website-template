---
import type { ImageMetadata } from 'astro';
import { Image, getImage } from 'astro:assets';

interface Props {
  src: ImageMetadata;
  alt: string;
  class?: string;
  loading?: 'lazy' | 'eager';
  fetchpriority?: 'high' | 'low' | 'auto';
  sizes?: string;
  width?: number;
  height?: number;
}

const { 
  src, 
  alt, 
  class: className = '', 
  loading = 'lazy', 
  fetchpriority = 'auto',
  sizes = '(min-width: 1024px) 100vw, 100vw',
  width,
  height
} = Astro.props;

// Generate low-res placeholder (20px width)
const placeholder = await getImage({
  src,
  width: 20,
  format: 'webp',
  quality: 50,
});

const placeholderStyle = `background-image: url('${placeholder.src}'); background-size: cover; background-position: center;`;

const isEager = loading === 'eager';
const imageClass = isEager 
  ? `w-full h-full object-cover relative z-20 ${className}` 
  : `w-full h-full object-cover relative z-20 opacity-0 transition-opacity duration-500 ${className}`;

const onloadHandler = isEager 
  ? undefined 
  : "this.classList.remove('opacity-0'); this.previousElementSibling.classList.add('opacity-0');";
---

<div class={`relative overflow-hidden bg-stone-200 ${className}`} style={placeholderStyle}>
  {/* Blur layer - only render if lazy loading or if we want the blur effect behind the eager image (but eager image should hide it) */}
  {/* If eager, we might skip the blur layer entirely to save DOM nodes, or keep it as fallback. Let's keep it but handle opacity. */}
  <div 
    class={`absolute inset-0 backdrop-blur-xl scale-110 transition-opacity duration-700 pointer-events-none z-10 ${isEager ? 'opacity-0' : ''}`}
    aria-hidden="true"
  ></div>
  
  {/* Main Image */}
  <Image
    src={src}
    alt={alt}
    width={width || src.width}
    height={height || src.height}
    widths={[640, 768, 1024, 1280, 1536, 1920]}
    sizes={sizes}
    loading={loading}
    fetchpriority={fetchpriority}
    format="avif"
    class={imageClass}
    onload={onloadHandler}
  />
</div>
