---
import { useTranslations } from '../lib/i18n';
import events from '../data/events.json';
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

const t = useTranslations(Astro.currentLocale || 'en');

// Helper to import images dynamically
const images = import.meta.glob<{ default: ImageMetadata }>('/src/assets/**/*.{jpeg,jpg,png,gif}');

// Fallback image if dynamic import fails or path is external
const getImagePath = (path: string) => {
    // For this template, we are using public images referenced in JSON
    // In a real Astro app with image optimization, we would resolve these
    return path;
}

// Generate Event Schema
const eventsSchema = {
  "@context": "https://schema.org",
  "@graph": events.filter(e => e.type === 'event').map(event => ({
    "@type": "Event",
    "name": event.name,
    "description": event.description,
    "startDate": event.date, // Assuming ISO format in JSON
    "eventStatus": "https://schema.org/EventScheduled",
    "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
    "location": {
      "@type": "Place",
      "name": t('site.title'),
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "123 Mission St",
        "addressLocality": "San Francisco",
        "postalCode": "94105",
        "addressRegion": "CA",
        "addressCountry": "US"
      }
    },
    "image": [
      `https://risuandoak.com${event.image}`
    ],
    "offers": {
        "@type": "Offer",
        "price": event.price?.replace('$', ''),
        "priceCurrency": "USD",
        "url": `https://risuandoak.com${event.url}`
    }
  }))
};
---

<section id="events" class="py-24 md:py-32 bg-white text-charcoal scroll-mt-20">
  <div class="max-w-7xl mx-auto px-4 md:px-8">
    <div class="text-center mb-16 md:mb-24 reveal-on-scroll">
      <span class="text-xs font-sans uppercase tracking-[0.2em] text-charcoal/60 mb-4 block">{t('events.subtitle')}</span>
      <h2 class="text-4xl md:text-5xl font-serif font-medium mb-6">{t('events.title')}</h2>
      <p class="max-w-2xl mx-auto text-lg text-charcoal/80 font-serif italic">
        {t('events.description')}
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 md:gap-12 reveal-on-scroll" data-delay="200">
      {events.map((event) => (
        <article class="group flex flex-col bg-stone-50 rounded-sm overflow-hidden border border-stone-100 transition-all duration-300 hover:shadow-md hover:-translate-y-1">
          <div class="relative aspect-[4/3] overflow-hidden">
             <img 
                src={event.image} 
                alt={event.name}
                class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
                loading="lazy"
             />
             <div class="absolute inset-0 bg-black/10 group-hover:bg-black/0 transition-colors duration-300"></div>
             
             {/* Date Badge */}
             <div class="absolute top-4 left-4 bg-white/95 backdrop-blur-sm px-4 py-2 text-xs font-sans uppercase tracking-widest font-semibold text-charcoal shadow-sm">
                {event.recurrence || (event.date && new Date(event.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }))}
             </div>
          </div>
          
          <div class="p-8 flex flex-col flex-grow">
            <h3 class="text-2xl font-serif font-medium mb-3">{event.name}</h3>
            <p class="text-charcoal/70 mb-6 flex-grow leading-relaxed">
                {event.description}
            </p>
            
            <div class="pt-6 border-t border-stone-200 flex items-center justify-between mt-auto">
                <span class="font-serif text-lg text-amber-900">{event.price || 'Market Price'}</span>
                
                <a 
                    href={event.url || '#contact'} 
                    class="inline-flex items-center text-sm font-sans font-semibold uppercase tracking-wider hover:text-amber-900 transition-colors"
                >
                    {t('events.cta')}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                </a>
            </div>
          </div>
        </article>
      ))}
      
      {/* Private Dining Card - Always present */}
      <article class="flex flex-col bg-charcoal text-stone-50 rounded-sm overflow-hidden p-8 md:p-12 justify-center items-center text-center">
         <h3 class="text-2xl md:text-3xl font-serif font-medium mb-4 text-white">Private Dining</h3>
         <p class="text-stone-300 mb-8 leading-relaxed max-w-sm">
            Host your own exclusive event in our private wine cellar or chef's tasting room. Perfect for celebrations and corporate gatherings.
         </p>
         <a 
            href="mailto:events@risuandoak.com" 
            class="inline-block px-8 py-3 border border-stone-50/30 hover:border-stone-50 hover:bg-stone-50 hover:text-charcoal transition-all duration-300 text-sm font-sans font-semibold uppercase tracking-widest"
         >
            Contact Events Team
         </a>
      </article>
    </div>
  </div>

  <script type="application/ld+json" set:html={JSON.stringify(eventsSchema)} />
</section>
